<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SPAWT">
<meta name="theme-color" content="#0C0C0E">
<title>SPAWT Collecte</title>
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjMEMwQzBFIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSI1MCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC13ZWlnaHQ9IjkwMCIgZmlsbD0iI0Y5NzMxNiI+U1A8L3RleHQ+PC9zdmc+">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU1BBV1QgQ29sbGVjdGUiLCJzaG9ydF9uYW1lIjoiU1BBV1QiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBDMEMwRSIsInRoZW1lX2NvbG9yIjoiIzBDMEMwRSJ9">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0C0C0E;--surface:#161619;--card:#1A1A1F;--card2:#1E1E24;--border:#2A2A30;
--accent:#F97316;--accent-soft:rgba(249,115,22,0.12);--accent-glow:rgba(249,115,22,0.25);
--green:#22c55e;--green-soft:rgba(34,197,94,0.12);
--text:#E8E6E3;--muted:#8A8A8E;--dim:#5A5A5E;
--danger:#EF4444;--white:#FFFFFF;
--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
--radius:12px;--radius-sm:8px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display',sans-serif;font-size:14px;-webkit-font-smoothing:antialiased}
input,textarea,select,button{font-family:inherit;font-size:inherit}
input[type="date"],input[type="time"],input[type="number"],input[type="tel"]{-webkit-appearance:none;appearance:none}

#app{height:100%;display:flex;flex-direction:column}

/* â”€â”€â”€ Header â”€â”€â”€ */
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;padding-top:calc(10px + var(--safe-top));border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;min-height:54px}
.header-title{font-size:22px;font-weight:800;color:var(--accent);letter-spacing:2px;font-family:'Courier New',monospace}
.header-sub{font-size:11px;color:var(--dim);margin-top:1px}

/* â”€â”€â”€ Progress Bar â”€â”€â”€ */
.progress-bar{height:3px;background:var(--border);flex-shrink:0;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),#fb923c);transition:width .5s cubic-bezier(.4,0,.2,1);border-radius:0 2px 2px 0}

/* â”€â”€â”€ Buttons â”€â”€â”€ */
.btn{border:none;cursor:pointer;border-radius:var(--radius-sm);font-weight:600;transition:all .15s;-webkit-user-select:none}
.btn:active{opacity:.7;transform:scale(.97)}
.btn-primary{background:var(--accent);color:var(--white);padding:10px 18px;font-size:13px;font-weight:700;border-radius:var(--radius)}
.btn-icon{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);font-size:16px;border-radius:var(--radius-sm)}
.btn-back{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:none;color:var(--muted);font-size:18px;border-radius:var(--radius-sm)}
.btn-save{width:38px;height:38px;display:flex;align-items:center;justify-content:center;background:var(--accent-soft);border:1px solid var(--accent);border-radius:var(--radius-sm);font-size:16px}
.btn-secondary{width:100%;padding:12px;background:var(--card);color:var(--accent);border:1px solid var(--border);font-size:13px;font-weight:600;margin-bottom:8px;border-radius:var(--radius)}
.btn-nav{flex:1;padding:14px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:13px;font-weight:600;border-radius:var(--radius)}
.btn-nav-primary{flex:1;padding:14px;background:var(--accent);color:var(--white);font-size:13px;font-weight:700;border-radius:var(--radius)}
.btn-danger{background:none;border:none;color:var(--danger);font-size:12px;padding:10px;opacity:.6}

/* â”€â”€â”€ Form Elements â”€â”€â”€ */
.field{margin-bottom:16px}
.label{display:block;font-size:11px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.label .req{color:var(--accent);margin-left:2px}
.input{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:15px;outline:none;transition:border-color .2s,box-shadow .2s}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.input::placeholder{color:var(--dim)}
textarea.input{resize:vertical;min-height:60px}

/* â”€â”€â”€ Field Groups (cards) â”€â”€â”€ */
.field-group{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 16px 4px;margin-bottom:16px}
.field-group-title{font-size:12px;font-weight:700;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.field-group-title .fg-icon{font-size:14px;opacity:.7}

/* â”€â”€â”€ Chips â”€â”€â”€ */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:8px 14px;border-radius:20px;border:1px solid var(--border);font-size:13px;font-weight:500;cursor:pointer;background:var(--surface);color:var(--muted);white-space:nowrap;transition:all .2s cubic-bezier(.4,0,.2,1)}
.chip:active{transform:scale(.93)}
.chip.active{background:var(--accent-soft);border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft)}

/* â”€â”€â”€ Slider â”€â”€â”€ */
.slider-wrap{margin-bottom:20px}
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;height:6px;border-radius:3px;outline:none;cursor:pointer;background:var(--border)}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:13px;background:var(--accent);cursor:pointer;border:3px solid var(--bg);box-shadow:0 2px 8px rgba(249,115,22,.35)}
input[type="range"]::-moz-range-thumb{width:26px;height:26px;border-radius:13px;background:var(--accent);cursor:pointer;border:3px solid var(--bg);box-shadow:0 2px 8px rgba(249,115,22,.35)}
.slider-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-top:8px;align-items:center}
.slider-val{color:var(--accent);font-weight:800;font-size:20px;background:var(--accent-soft);padding:2px 10px;border-radius:8px;min-width:36px;text-align:center}

/* â”€â”€â”€ Stars â”€â”€â”€ */
.stars{display:flex;gap:6px;margin-bottom:14px}
.star{background:none;border:none;font-size:32px;padding:4px;cursor:pointer;transition:transform .15s}
.star:active{transform:scale(1.2)}
.star.off{filter:grayscale(1) opacity(.3)}

/* â”€â”€â”€ Toggle â”€â”€â”€ */
.toggle-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.toggle-track{width:48px;height:28px;border-radius:14px;position:relative;cursor:pointer;transition:background .25s;border:none;flex-shrink:0}
.toggle-track.on{background:var(--accent)}
.toggle-track.off{background:var(--border)}
.toggle-thumb{width:22px;height:22px;border-radius:11px;background:var(--white);position:absolute;top:3px;transition:left .25s cubic-bezier(.4,0,.2,1);box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-label{font-size:14px;color:var(--text)}

/* â”€â”€â”€ Section Header â”€â”€â”€ */
.section-hdr{display:flex;align-items:center;gap:10px;margin-bottom:8px;margin-top:8px}
.section-hdr h3{margin:0;color:var(--accent);font-size:15px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap}
.section-hdr .line{flex:1;height:1px;background:var(--border)}
.section-hint{font-size:12px;color:var(--dim);margin-bottom:20px;line-height:1.5;padding-left:2px}

/* â”€â”€â”€ Entry Card â”€â”€â”€ */
.entry-card{width:100%;display:block;text-align:left;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;cursor:pointer;transition:all .15s}
.entry-card:active{background:var(--surface);transform:scale(.98)}
.entry-name{color:var(--text);font-weight:700;font-size:16px}
.entry-meta{color:var(--muted);font-size:12px;margin-top:4px}
.entry-date{color:var(--dim);font-size:11px}
.entry-accroche{color:var(--accent);font-size:12px;font-style:italic;margin-top:6px;opacity:.8}

/* â”€â”€â”€ Bloc Nav â”€â”€â”€ */
.bloc-nav{display:flex;overflow-x:auto;padding:8px 12px;gap:4px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.bloc-nav::-webkit-scrollbar{display:none}
.bloc-tab{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;border-radius:var(--radius-sm);border:none;background:none;color:var(--dim);cursor:pointer;min-width:56px;font-size:10px;font-weight:600;position:relative;transition:all .2s}
.bloc-tab.active{background:var(--accent-soft);color:var(--accent)}
.bloc-tab .ico{font-size:18px}
.bloc-tab .dot{width:6px;height:6px;border-radius:3px;position:absolute;top:4px;right:6px}
.bloc-tab .dot.empty{background:var(--dim);opacity:.3}
.bloc-tab .dot.partial{background:var(--accent)}
.bloc-tab .dot.complete{background:var(--green)}

/* â”€â”€â”€ Bottom Bar â”€â”€â”€ */
.bottom-bar{display:flex;gap:8px;padding:12px 16px;padding-bottom:calc(12px + var(--safe-bottom));background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}

/* â”€â”€â”€ Scroll Area â”€â”€â”€ */
.scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px}
.scroll.slide-in{animation:slideIn .3s cubic-bezier(.4,0,.2,1)}
@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideInReverse{from{opacity:0;transform:translateX(-40px)}to{opacity:1;transform:translateX(0)}}
.scroll.slide-in-reverse{animation:slideInReverse .3s cubic-bezier(.4,0,.2,1)}
.list-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 16px;padding-bottom:80px}

/* â”€â”€â”€ Search â”€â”€â”€ */
.search-bar{padding:10px 16px 0}
.filter-row{display:flex;gap:6px;overflow-x:auto;padding:8px 16px 10px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.filter-chip{padding:6px 12px;border-radius:14px;border:1px solid var(--border);background:var(--surface);color:var(--muted);font-size:12px;cursor:pointer;white-space:nowrap;transition:all .15s}
.filter-chip.active{border-color:var(--accent);background:var(--accent-soft);color:var(--accent)}

/* â”€â”€â”€ Grid â”€â”€â”€ */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid-time{display:grid;grid-template-columns:auto 1fr auto 1fr;gap:8px;align-items:center;margin-bottom:12px}
.mini-label{font-size:12px;color:var(--muted);font-weight:600}

/* â”€â”€â”€ Empty â”€â”€â”€ */
.empty{text-align:center;padding:60px 20px}
.empty-ico{font-size:56px;margin-bottom:20px}
.empty-txt{color:var(--muted);font-size:15px;line-height:1.6}

/* â”€â”€â”€ Stats bar â”€â”€â”€ */
.stats-row{display:flex;gap:8px;padding:8px 16px;flex-wrap:wrap}
.stat-badge{padding:4px 10px;border-radius:10px;font-size:11px;font-weight:600;background:var(--surface);border:1px solid var(--border);color:var(--muted)}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast-container{position:fixed;bottom:calc(80px + var(--safe-bottom));left:16px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{padding:14px 18px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-weight:500;pointer-events:auto;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.4);animation:toastIn .35s cubic-bezier(.4,0,.2,1)}
.toast.success{border-color:var(--green);background:linear-gradient(135deg,var(--card),var(--green-soft))}
.toast.info{border-color:var(--accent)}
.toast.leaving{animation:toastOut .3s ease forwards}
@keyframes toastIn{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes toastOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(20px)}}

/* â”€â”€â”€ Bottom Sheet Modal â”€â”€â”€ */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.modal-backdrop.active{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.bottom-sheet{width:100%;max-width:420px;background:var(--card);border-radius:20px 20px 0 0;padding:28px 24px;padding-bottom:calc(28px + var(--safe-bottom));animation:sheetUp .35s cubic-bezier(.4,0,.2,1)}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 20px}
.sheet-title{font-size:17px;font-weight:700;color:var(--text);margin-bottom:8px}
.sheet-msg{font-size:14px;color:var(--muted);margin-bottom:24px;line-height:1.5}
.sheet-actions{display:flex;gap:10px}
.sheet-actions .btn{flex:1;padding:14px;font-size:14px;border-radius:var(--radius)}
.btn-sheet-cancel{background:var(--surface);color:var(--muted);border:1px solid var(--border)}
.btn-sheet-danger{background:var(--danger);color:var(--white)}
.btn-sheet-confirm{background:var(--accent);color:var(--white)}

/* â”€â”€â”€ Draft Banner â”€â”€â”€ */
.draft-banner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--accent-soft);border-bottom:1px solid rgba(249,115,22,.2)}
.draft-banner-text{font-size:13px;color:var(--accent);font-weight:500}
.draft-banner-actions{display:flex;gap:8px}
.draft-banner-actions .btn{padding:6px 14px;font-size:12px}
.btn-draft-restore{background:var(--accent);color:var(--white);border-radius:var(--radius-sm)}
.btn-draft-dismiss{background:none;color:var(--muted);border:1px solid var(--border);border-radius:var(--radius-sm)}

/* â”€â”€â”€ Summary Card â”€â”€â”€ */
.summary-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.summary-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.summary-row:last-child{border-bottom:none}
.summary-key{color:var(--muted)}
.summary-val{color:var(--text);font-weight:600;text-align:right;max-width:60%}
.summary-val.empty{color:var(--dim);font-weight:400;font-style:italic}

/* â”€â”€â”€ Quick Capture â”€â”€â”€ */
.quick-header{text-align:center;padding:24px 0 12px}
.quick-title{font-size:24px;font-weight:800;color:var(--accent);letter-spacing:1px}
.quick-sub{font-size:13px;color:var(--muted);margin-top:6px}
.quick-input{width:100%;padding:16px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:20px;font-weight:700;outline:none;transition:border-color .2s;text-align:center}
.quick-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}
.quick-input::placeholder{color:var(--dim);font-weight:400;font-size:16px}
.quick-section{margin-top:22px;margin-bottom:10px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.quick-gps{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--muted);font-size:13px;margin-bottom:12px;transition:all .3s}
.quick-gps.captured{border-color:var(--green);color:var(--green);background:var(--green-soft)}
.quick-gps .gps-dot{width:10px;height:10px;border-radius:5px;background:var(--dim);flex-shrink:0;transition:background .3s}
.quick-gps.captured .gps-dot{background:var(--green);box-shadow:0 0 8px rgba(34,197,94,.5)}
.quick-actions{display:flex;gap:10px;margin-top:28px;padding-bottom:calc(16px + var(--safe-bottom))}
.quick-actions .btn{flex:1;padding:16px;font-size:14px;border-radius:var(--radius)}
.btn-quick-save{background:var(--accent);color:var(--white);font-weight:700}
.btn-quick-full{background:var(--card);color:var(--accent);border:1px solid var(--accent);font-weight:600}

/* â”€â”€â”€ Photo Capture â”€â”€â”€ */
.photo-wrap{margin-bottom:16px}
.photo-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:16px;background:var(--surface);border:2px dashed var(--border);border-radius:var(--radius);color:var(--muted);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
.photo-btn:active{background:var(--card);border-color:var(--accent);color:var(--accent);transform:scale(.97)}
.photo-preview{position:relative;margin-top:10px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.photo-preview img{width:100%;height:180px;object-fit:cover;display:block}
.photo-remove{position:absolute;top:8px;right:8px;width:34px;height:34px;border-radius:17px;background:rgba(0,0,0,.75);border:none;color:var(--white);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.photo-remove:active{background:var(--danger)}

/* â”€â”€â”€ Native Select Dropdown â”€â”€â”€ */
.select-native{width:100%;padding:12px 14px;padding-right:38px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:15px;outline:none;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238A8A8E' stroke-width='2' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;transition:border-color .2s}
.select-native:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-soft)}

/* â”€â”€â”€ Draft/Enrich Badge â”€â”€â”€ */
.badge-enrich{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(249,115,22,.3);margin-left:6px;vertical-align:middle}

/* â”€â”€â”€ Profile Cards â”€â”€â”€ */
.profiles-row{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.profiles-row::-webkit-scrollbar{display:none}
.profile-card{flex-shrink:0;padding:14px 16px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);cursor:pointer;text-align:center;min-width:90px;transition:all .2s}
.profile-card:active{background:var(--card);border-color:var(--accent);transform:scale(.95)}
.profile-card.selected{border-color:var(--accent);background:var(--accent-soft)}
.profile-card .profile-icon{font-size:28px;margin-bottom:4px}
.profile-card .profile-name{font-size:12px;font-weight:700;color:var(--text)}
.profile-card .profile-desc{font-size:10px;color:var(--dim);margin-top:2px}

/* â”€â”€â”€ Collapsible Groups â”€â”€â”€ */
.collapsible-title{cursor:pointer;-webkit-user-select:none;user-select:none}
.collapse-arrow{margin-left:auto;font-size:10px;color:var(--dim);transition:transform .2s}

/* â”€â”€â”€ Voice Memo â”€â”€â”€ */
.voice-btn{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--muted);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.voice-btn:active{background:var(--card)}
.voice-btn.recording{border-color:var(--danger);color:var(--danger);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.voice-timer{font-size:13px;color:var(--danger);font-weight:700;font-variant-numeric:tabular-nums}

/* â”€â”€â”€ Swipe Card â”€â”€â”€ */
.card-swipe-wrap{position:relative;overflow:hidden;border-radius:var(--radius);margin-bottom:10px}
.card-swipe-wrap .entry-card{margin-bottom:0;transition:transform .2s ease;position:relative;z-index:1}
.card-swipe-actions{position:absolute;right:0;top:0;bottom:0;display:flex;align-items:stretch;z-index:0}
.card-swipe-action{display:flex;align-items:center;padding:0 18px;font-size:18px;border:none;cursor:pointer;color:var(--white);font-weight:700}
.card-action-delete{background:var(--danger)}
.card-action-share{background:#25D366}
.card-action-clone{background:var(--accent)}

/* â”€â”€â”€ Offline Indicator â”€â”€â”€ */
.offline-bar{display:flex;align-items:center;justify-content:center;gap:8px;padding:8px 16px;background:var(--accent-soft);border-bottom:1px solid rgba(249,115,22,.2);font-size:12px;color:var(--accent);font-weight:600}
.online-dot{width:8px;height:8px;border-radius:4px;flex-shrink:0}
.online-dot.on{background:var(--green);box-shadow:0 0 6px rgba(34,197,94,.5)}
.online-dot.off{background:var(--danger);box-shadow:0 0 6px rgba(239,68,68,.5)}

/* â”€â”€â”€ Sort Controls â”€â”€â”€ */
.sort-row{display:flex;gap:6px;padding:4px 16px 8px;align-items:center}
.sort-label{font-size:11px;color:var(--dim);font-weight:600;white-space:nowrap}
.sort-chip{padding:4px 10px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--dim);font-size:11px;cursor:pointer;white-space:nowrap;transition:all .15s}
.sort-chip.active{border-color:var(--accent);background:var(--accent-soft);color:var(--accent)}

/* â”€â”€â”€ Suggestion chips â”€â”€â”€ */
.suggest-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.suggest-chip{padding:3px 8px;border-radius:10px;border:1px dashed var(--border);font-size:11px;color:var(--dim);cursor:pointer;background:none;transition:all .15s}
.suggest-chip:active{border-color:var(--accent);color:var(--accent)}
</style>
</head>
<body>
<div id="app"></div>
<div class="toast-container" id="toast-container"></div>
<div class="modal-backdrop" id="modal-backdrop"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPAWT FIELD COLLECTION PWA â€” v2.0 Ergonomic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = "spawt-entries";
const DRAFT_KEY = "spawt-draft";
const SPAWTER_KEY = "spawt-last-spawter";

// â”€â”€â”€ Data Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const C = {
  types: ["Maquis","Restaurant","Gargote","Street food","Bistrot","Fine dining","Snack"],
  cuisines: ["Ivoirienne","Africaine (autre)","FranÃ§aise","Libanaise","Asiatique","Fast food","Fusion"],
  digital: ["WhatsApp","Facebook","Instagram","Site web"],
  menu: ["Carte physique photographiÃ©e","Ardoise","Verbal uniquement"],
  paiements: ["Cash","Orange Money","MTN","Moov","Wave","CB","Virement"],
  parking: ["Facile","ModÃ©rÃ©","Difficile","Impossible"],
  services: ["Livraison","Ã€ emporter","Climatisation","WiFi","Terrasse","Bar","Fumeurs acceptÃ©s"],
  tags: [{id:"exact",e:"ğŸ¯",l:"Exact"},{id:"surprise",e:"ğŸ¤©",l:"Surprise"},{id:"rapport",e:"ğŸ’¸",l:"QualitÃ©-prix"},{id:"banal",e:"ğŸ˜",l:"Banal"},{id:"decevant",e:"ğŸ˜",l:"DÃ©cevant"}],
  reco: ["Absolument","Oui","Peut-Ãªtre","Non"],
  clientele: ["Cadres/Pro","Ã‰tudiants","Familles","Couples","Solo","Touristes","Mixte"],
  moments: ["Petit-dÃ©j","DÃ©jeuner","GoÃ»ter","DÃ®ner","Tard dans la nuit"],
  affluence: ["Vide","Calme","ModÃ©rÃ©e","BondÃ©","File d'attente"],
  sonore: ["Calme","Ambiance musicale","AnimÃ©","Bruyant"],
  proprete: ["Impeccable","Correcte","Passable","ProblÃ©matique"],
  accueil: ["Chaleureux","Pro","Distant","DÃ©sagrÃ©able"],
  potentiel: [{id:"pepite",e:"ğŸ”¥",l:"PÃ‰PITE"},{id:"coup_coeur",e:"â¤ï¸",l:"COUP DE CÅ’UR"},{id:"solide",e:"âœ…",l:"SOLIDE"},{id:"moyen",e:"âš ï¸",l:"MOYEN"},{id:"skip",e:"âŒ",l:"SKIP"}],
  receptivite: ["TrÃ¨s intÃ©ressÃ©","Ouvert","Sceptique","Refus"],
  fonction: ["PropriÃ©taire","GÃ©rant","Responsable"],
  materiel: ["Flyer","Pitch deck","Carte de visite"],
  quartiers: ["Cocody","Plateau","Marcory","Treichville","Yopougon","Abobo","AdjamÃ©","Koumassi","Port-BouÃ«t","Bingerville","Riviera","2 Plateaux","AngrÃ©","Zone 4","Vallon","Bassam","Assinie","BouakÃ©"],
};

// â”€â”€â”€ Profils rapides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROFILES = [
  {id:"maquis",icon:"ğŸ–",name:"Maquis",desc:"Populaire",defaults:{types:["Maquis"],cuisines:["Ivoirienne"],budget:4,ambiance:3,sociabilite:9,cadence:5,notoriete:5}},
  {id:"restaurant",icon:"ğŸ½ï¸",name:"Restaurant",desc:"Classique",defaults:{types:["Restaurant"],budget:7,ambiance:7,cadence:6,sociabilite:6,notoriete:6}},
  {id:"gargote",icon:"ğŸ²",name:"Gargote",desc:"Ã‰conomique",defaults:{types:["Gargote"],cuisines:["Ivoirienne"],budget:3,cadence:7,ambiance:2,sociabilite:8,notoriete:4}},
  {id:"street",icon:"ğŸŒ­",name:"Street Food",desc:"Rapide",defaults:{types:["Street food"],budget:2,cadence:10,ambiance:2,sociabilite:7,notoriete:3}},
  {id:"fine",icon:"âœ¨",name:"Fine Dining",desc:"Haut de gamme",defaults:{types:["Fine dining"],budget:11,ambiance:11,cadence:4,sociabilite:4,notoriete:8}},
  {id:"bistrot",icon:"ğŸ·",name:"Bistrot",desc:"DÃ©contractÃ©",defaults:{types:["Bistrot"],budget:6,ambiance:6,cadence:5,sociabilite:7,notoriete:5}},
];

// â”€â”€â”€ Price Range Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PRICE_RANGES = {
  eco: [{l:"< 1 500",min:"0",max:"1500"},{l:"1 500â€“2 500",min:"1500",max:"2500"},{l:"2 500â€“4 000",min:"2500",max:"4000"},{l:"4 000+",min:"4000",max:""}],
  moy: [{l:"3â€“5 000",min:"3000",max:"5000"},{l:"5â€“8 000",min:"5000",max:"8000"},{l:"8â€“12 000",min:"8000",max:"12000"},{l:"12 000+",min:"12000",max:""}],
  prem: [{l:"8â€“15 000",min:"8000",max:"15000"},{l:"15â€“25 000",min:"15000",max:"25000"},{l:"25â€“50 000",min:"25000",max:"50000"},{l:"50 000+",min:"50000",max:""}],
  boiss: [{l:"< 500",min:"0",max:"500"},{l:"500â€“1 000",min:"500",max:"1000"},{l:"1â€“2 500",min:"1000",max:"2500"},{l:"2 500+",min:"2500",max:""}],
};

// â”€â”€â”€ Hour Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HOUR_PRESETS = [
  {l:"6hâ€“20h",de:"06:00",a:"20:00"},
  {l:"7hâ€“22h",de:"07:00",a:"22:00"},
  {l:"8hâ€“23h",de:"08:00",a:"23:00"},
  {l:"10hâ€“2h",de:"10:00",a:"02:00"},
  {l:"11hâ€“23h",de:"11:00",a:"23:00"},
  {l:"24h/24",de:"00:00",a:"23:59"},
];

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = {
  view: "list",
  entries: [],
  current: null,
  bloc: 0,
  prevBloc: 0,
  search: "",
  filterPot: "",
  sortBy: "date",
  isOnline: navigator.onLine,
};

function lastSpawter() {
  try { return localStorage.getItem(SPAWTER_KEY) || ""; } catch(e) { return ""; }
}

function emptyEntry() {
  return {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,7),
    ts: new Date().toISOString(),
    nom:"",adresse:"",quartier:"",gpsLat:"",gpsLong:"",dateVisite:new Date().toISOString().slice(0,10),spawter:lastSpawter(),
    telephone:"",digital:[],urlHandle:"",
    photoLieu:"",photoMenu:"",photoPlats:"",quickCapture:false,profile:"",
    types:[],autreType:"",specs:["","",""],cuisines:[],autreCuisine:"",platsSignature:"",
    ecoMin:"",ecoMax:"",moyMin:"",moyMax:"",premMin:"",premMax:"",boissMin:"",boissMax:"",menuType:[],
    budget:6,budgetEst:"",cadence:6,tempsAtt:"",ambiance:6,ambianceN:"",sociabilite:6,sociabiliteN:"",notoriete:6,notorieteN:"",
    hLVde:"",hLVa:"",hSde:"",hSa:"",hDde:"",hDa:"",dimFerme:false,continu:"",coupures:"",joursFerm:"",
    capInt:"",capExt:"",paiements:[],parking:"",parkingN:"",services:[],
    tested:false,platsTestes:"",budgetTest:"",eval:3,forts:["","",""],faibles:["","",""],
    tags:[],reco:"",accroche:"",
    clientele:[],moments:[],affluence:"",sonore:"",proprete:"",serveurs:"",accueil:"",potentiel:"",notes:"",voiceNotes:"",
    contactEtabli:"",contactNom:"",fonction:"",receptivite:"",rdv:false,rdvDate:"",materiel:[],notesB2B:"",voiceB2B:"",
  };
}

// â”€â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entries)); } catch(e) { console.error(e); }
}
function load() {
  try { const d = localStorage.getItem(STORAGE_KEY); if(d) state.entries = JSON.parse(d); } catch(e) {}
}

// â”€â”€â”€ Draft Auto-Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let draftTimer = null;
function saveDraft() {
  if(draftTimer) clearTimeout(draftTimer);
  draftTimer = setTimeout(() => {
    if(state.current) {
      try { localStorage.setItem(DRAFT_KEY, JSON.stringify({entry:state.current,bloc:state.bloc,ts:Date.now()})); } catch(e) {}
    }
  }, 800);
}
function loadDraft() {
  try { const d = localStorage.getItem(DRAFT_KEY); return d ? JSON.parse(d) : null; } catch(e) { return null; }
}
function clearDraft() {
  if(draftTimer) clearTimeout(draftTimer);
  try { localStorage.removeItem(DRAFT_KEY); } catch(e) {}
}

// â”€â”€â”€ Toast System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type="info", icon="") {
  const container = document.getElementById("toast-container");
  const icons = {success:"âœ“",info:"â„¹",warning:"âš "};
  const ico = icon || icons[type] || "";
  const toast = h("div",`toast ${type}`,`<span style="font-size:16px">${ico}</span> ${msg}`);
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add("leaving");
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// â”€â”€â”€ Bottom Sheet Confirm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showConfirm(title, msg, confirmLabel, onConfirm, danger=false) {
  const backdrop = document.getElementById("modal-backdrop");
  backdrop.className = "modal-backdrop active";
  backdrop.innerHTML = "";
  const sheet = h("div","bottom-sheet");
  sheet.appendChild(h("div","sheet-handle"));
  sheet.appendChild(h("div","sheet-title",title));
  sheet.appendChild(h("div","sheet-msg",msg));
  const actions = h("div","sheet-actions");
  const cancelBtn = h("button","btn btn-sheet-cancel","Annuler");
  cancelBtn.addEventListener("click", () => { backdrop.className = "modal-backdrop"; });
  const confirmBtn = h("button",`btn ${danger?"btn-sheet-danger":"btn-sheet-confirm"}`,confirmLabel);
  confirmBtn.addEventListener("click", () => { backdrop.className = "modal-backdrop"; onConfirm(); });
  actions.appendChild(cancelBtn);
  actions.appendChild(confirmBtn);
  sheet.appendChild(actions);
  backdrop.appendChild(sheet);
  backdrop.addEventListener("click", e => {
    if(e.target === backdrop) backdrop.className = "modal-backdrop";
  });
}

// â”€â”€â”€ Progress Calc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcBlocProgress(bloc) {
  const e = state.current;
  if(!e) return 0;
  const filled = v => v && (Array.isArray(v) ? v.length > 0 : String(v).trim().length > 0);
  switch(bloc) {
    case 0: {
      const f = [e.nom,e.adresse,e.quartier,e.dateVisite,e.spawter];
      return f.filter(filled).length / f.length;
    }
    case 1: {
      const f = [(e.types||[]).length>0,(e.cuisines||[]).length>0];
      return f.filter(Boolean).length / f.length;
    }
    case 2: return 1;
    case 3: {
      const f = [e.hLVde,(e.paiements||[]).length>0];
      return f.filter(filled).length / f.length;
    }
    case 4: {
      const f = [e.reco];
      return f.filter(filled).length / f.length;
    }
    case 5: {
      const f = [e.potentiel,(e.clientele||[]).length>0];
      return f.filter(filled).length / f.length;
    }
    case 6: {
      const f = [e.contactEtabli];
      return f.filter(filled).length / f.length;
    }
  }
  return 0;
}
function calcTotalProgress() {
  let sum = 0;
  for(let i = 0; i < BLOCS.length; i++) sum += calcBlocProgress(i);
  return sum / BLOCS.length;
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = (s,p) => (p||document).querySelector(s);
const $$ = (s,p) => [...(p||document).querySelectorAll(s)];
const h = (tag, cls, html, attrs) => {
  const el = document.createElement(tag);
  if(cls) el.className = cls;
  if(html !== undefined && html !== null) el.innerHTML = html;
  if(attrs) Object.entries(attrs).forEach(([k,v]) => {
    if(k.startsWith("on")) el.addEventListener(k.slice(2).toLowerCase(), v);
    else el.setAttribute(k, v);
  });
  return el;
};

// â”€â”€â”€ Render Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkInput(label, field, type="text", placeholder="") {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const inp = h("input","input",null,{type,value:state.current[field]||"",placeholder});
  inp.addEventListener("input", e => { state.current[field] = e.target.value; saveDraft(); });
  d.appendChild(inp);
  return d;
}

function mkTextarea(label, field, placeholder="", rows=3) {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const ta = h("textarea","input",null,{placeholder,rows});
  ta.value = state.current[field] || "";
  ta.addEventListener("input", e => { state.current[field] = e.target.value; saveDraft(); });
  d.appendChild(ta);
  return d;
}

function mkArrayInput(label, field, index, placeholder="") {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const inp = h("input","input",null,{type:"text",value:(state.current[field]||[])[index]||"",placeholder});
  inp.addEventListener("input", e => {
    const arr = [...(state.current[field]||[])];
    arr[index] = e.target.value;
    state.current[field] = arr;
    saveDraft();
  });
  d.appendChild(inp);
  return d;
}

function mkChips(label, options, field, multi=true) {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const row = h("div","chips");
  options.forEach(opt => {
    const isObj = typeof opt === "object";
    const val = isObj ? opt.id : opt;
    const display = isObj ? `${opt.e} ${opt.l}` : opt;
    const cur = state.current[field];
    const active = multi ? (cur||[]).includes(val) : cur === val;
    const chip = h("button", `chip${active?" active":""}`, display);
    chip.addEventListener("click", () => {
      haptic();
      if(multi) {
        const arr = [...(state.current[field]||[])];
        const idx = arr.indexOf(val);
        if(idx>=0) arr.splice(idx,1); else arr.push(val);
        state.current[field] = arr;
      } else {
        state.current[field] = state.current[field] === val ? "" : val;
      }
      saveDraft();
      renderForm();
    });
    row.appendChild(chip);
  });
  d.appendChild(row);
  return d;
}

function mkSlider(label, field, leftL, rightL, leftIcon="", rightIcon="") {
  const d = h("div","slider-wrap");
  if(label) d.appendChild(h("label","label",label));
  const val = state.current[field] || 6;
  const pct = ((val - 1) / 11) * 100;
  const inp = h("input",null,null,{type:"range",min:"1",max:"12",value:String(val)});
  inp.style.background = `linear-gradient(to right, var(--accent) ${pct}%, var(--border) ${pct}%)`;
  inp.addEventListener("input", e => {
    state.current[field] = Number(e.target.value);
    const p = ((e.target.value - 1) / 11) * 100;
    e.target.style.background = `linear-gradient(to right, var(--accent) ${p}%, var(--border) ${p}%)`;
    const valEl = e.target.parentElement.querySelector(".slider-val");
    if(valEl) valEl.textContent = e.target.value;
    saveDraft();
  });
  d.appendChild(inp);
  const labels = h("div","slider-labels",
    `<span>${leftIcon} ${leftL}</span><span class="slider-val">${val}</span><span>${rightL} ${rightIcon}</span>`);
  d.appendChild(labels);
  return d;
}

function mkStars(field) {
  const d = h("div","stars");
  for(let i=1;i<=5;i++){
    const s = h("button","star","â­");
    if(i > state.current[field]) s.classList.add("off");
    s.addEventListener("click", () => { haptic(); state.current[field] = i; saveDraft(); renderForm(); });
    d.appendChild(s);
  }
  return d;
}

function mkToggle(label, field) {
  const d = h("div","toggle-row");
  const on = !!state.current[field];
  const track = h("button",`toggle-track ${on?"on":"off"}`);
  const thumb = h("div","toggle-thumb");
  thumb.style.left = on ? "23px" : "3px";
  track.appendChild(thumb);
  track.addEventListener("click", () => { haptic(); state.current[field] = !state.current[field]; saveDraft(); renderForm(); });
  d.appendChild(track);
  d.appendChild(h("span","toggle-label",label));
  return d;
}

function mkSection(title, icon) {
  const d = h("div","section-hdr");
  d.appendChild(h("span",null,icon));
  d.appendChild(h("h3",null,title));
  d.appendChild(h("div","line"));
  return d;
}

function mkHint(text) {
  return h("div","section-hint",text);
}

function mkGroup(title, children, icon) {
  const g = h("div","field-group");
  if(title) {
    const t = h("div","field-group-title", (icon?`<span class="fg-icon">${icon}</span> `:"")+title);
    g.appendChild(t);
  }
  children.forEach(c => { if(c) g.appendChild(c); });
  return g;
}

// â”€â”€â”€ Haptic Feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haptic() { try { navigator.vibrate && navigator.vibrate(10); } catch(e) {} }

// â”€â”€â”€ Reverse Geocoding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function reverseGeocode(lat, lng) {
  fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=16&addressdetails=1`)
    .then(r => r.json())
    .then(data => {
      if(!data.address) return;
      const a = data.address;
      const suburb = a.suburb || a.neighbourhood || a.city_district || "";
      if(suburb && !state.current.quartier) {
        const match = C.quartiers.find(q => suburb.toLowerCase().includes(q.toLowerCase()) || q.toLowerCase().includes(suburb.toLowerCase()));
        if(match) { state.current.quartier = match; }
      }
      if(!state.current.adresse && data.display_name) {
        state.current.adresse = data.display_name.split(",").slice(0,3).join(",").trim();
      }
      saveDraft();
    }).catch(() => {});
}

// â”€â”€â”€ Duplicate Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkDuplicate(entry) {
  return state.entries.find(e => {
    if(e.id === entry.id) return false;
    if(entry.nom && e.nom && e.nom.toLowerCase().trim() === entry.nom.toLowerCase().trim()) return e;
    if(entry.gpsLat && entry.gpsLong && e.gpsLat && e.gpsLong) {
      const dLat = Math.abs(Number(entry.gpsLat) - Number(e.gpsLat));
      const dLng = Math.abs(Number(entry.gpsLong) - Number(e.gpsLong));
      if(dLat < 0.0005 && dLng < 0.0005) return e;
    }
    return false;
  });
}

// â”€â”€â”€ Share via WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareEntry(entry) {
  const pot = C.potentiel.find(p=>p.id===entry.potentiel);
  const lines = [
    `*${entry.nom||"Sans nom"}*`,
    entry.quartier ? `ğŸ“ ${entry.quartier}` : "",
    (entry.types||[]).length ? `ğŸ·ï¸ ${entry.types.join(", ")}` : "",
    pot ? `${pot.e} ${pot.l}` : "",
    entry.accroche ? `\n_"${entry.accroche}"_` : "",
    entry.tested && entry.eval ? `\nâ­ ${entry.eval}/5` : "",
    `\nâ€” SPAWT Collecte`,
  ].filter(Boolean).join("\n");
  const url = `https://wa.me/?text=${encodeURIComponent(lines)}`;
  window.open(url, "_blank");
}

// â”€â”€â”€ Duplicate Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function duplicateEntry(entry) {
  const clone = JSON.parse(JSON.stringify(entry));
  clone.id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  clone.ts = new Date().toISOString();
  clone.nom = (clone.nom || "") + " (copie)";
  clone.quickCapture = true;
  state.entries.unshift(clone);
  save();
  renderList();
  showToast(`"${clone.nom}" dupliquÃ©`,"success","ğŸ“‹");
}

// â”€â”€â”€ Get Suggestions from History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSuggestions(field, index) {
  const vals = new Set();
  state.entries.forEach(e => {
    if(index !== undefined) {
      const arr = e[field];
      if(Array.isArray(arr) && arr[index]) vals.add(arr[index]);
    } else if(Array.isArray(e[field])) {
      e[field].forEach(v => { if(v) vals.add(v); });
    } else if(e[field]) { vals.add(e[field]); }
  });
  return [...vals].slice(0, 6);
}

// â”€â”€â”€ Collapsible Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkCollapsible(title, children, icon, startOpen) {
  const open = startOpen === undefined ? false : startOpen;
  const g = h("div","field-group");
  const tEl = h("div","field-group-title collapsible-title",
    (icon?`<span class="fg-icon">${icon}</span> `:"")+title+`<span class="collapse-arrow">${open?"â–¼":"â–¶"}</span>`);
  g.appendChild(tEl);
  const content = h("div","collapsible-content");
  if(!open) content.style.display = "none";
  children.forEach(c => { if(c) content.appendChild(c); });
  g.appendChild(content);
  tEl.addEventListener("click", () => {
    haptic();
    const arrow = tEl.querySelector(".collapse-arrow");
    if(content.style.display === "none") { content.style.display = "block"; arrow.textContent = "â–¼"; }
    else { content.style.display = "none"; arrow.textContent = "â–¶"; }
  });
  return g;
}

// â”€â”€â”€ Voice Memo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkVoiceMemo(label, field) {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const hasAudio = !!state.current[field];
  if(hasAudio) {
    const audio = h("audio",null,null,{controls:""});
    audio.src = state.current[field];
    audio.style.cssText = "width:100%;height:40px;margin-bottom:8px";
    d.appendChild(audio);
    const del = h("button","voice-btn","âœ• Supprimer");
    del.style.color = "var(--danger)";
    del.addEventListener("click", () => { state.current[field] = ""; saveDraft(); renderForm(); });
    d.appendChild(del);
  } else {
    let mr = null, chunks = [], timerInterval = null;
    const btn = h("button","voice-btn btn","ğŸ¤ MÃ©mo vocal");
    const timer = h("span","voice-timer","");
    timer.style.display = "none";
    btn.addEventListener("click", async () => {
      if(mr && mr.state === "recording") { mr.stop(); return; }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        chunks = [];
        mr = new MediaRecorder(stream);
        mr.ondataavailable = ev => { if(ev.data.size>0) chunks.push(ev.data); };
        mr.onstop = () => {
          stream.getTracks().forEach(t => t.stop());
          clearInterval(timerInterval);
          const blob = new Blob(chunks, {type:"audio/webm"});
          const reader = new FileReader();
          reader.onload = re => { state.current[field] = re.target.result; saveDraft(); renderForm(); };
          reader.readAsDataURL(blob);
        };
        mr.start(); haptic();
        btn.innerHTML = "â¹ï¸ ArrÃªter"; btn.classList.add("recording");
        let secs = 0; timer.style.display = "inline";
        timerInterval = setInterval(() => {
          secs++; timer.textContent = `${secs}s`;
          if(secs >= 60) mr.stop();
        }, 1000);
      } catch(err) { showToast("Micro non disponible","warning","âš "); }
    });
    const row = h("div",null,null);
    row.style.cssText = "display:flex;align-items:center;gap:8px";
    row.appendChild(btn); row.appendChild(timer);
    d.appendChild(row);
  }
  return d;
}

// â”€â”€â”€ Price Range Chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkPriceChips(label, fieldMin, fieldMax, presets) {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const row = h("div","chips");
  presets.forEach(p => {
    const isActive = state.current[fieldMin] === p.min && state.current[fieldMax] === p.max;
    const chip = h("button", `chip${isActive?" active":""}`, p.l);
    chip.addEventListener("click", () => {
      haptic();
      if(isActive) { state.current[fieldMin] = ""; state.current[fieldMax] = ""; }
      else { state.current[fieldMin] = p.min; state.current[fieldMax] = p.max; }
      saveDraft(); renderForm();
    });
    row.appendChild(chip);
  });
  d.appendChild(row);
  return d;
}

// â”€â”€â”€ Hour Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkHourPresets(fieldDe, fieldA) {
  const d = h("div","field");
  d.appendChild(h("label","label","Horaires rapides â€” 1 tap"));
  const row = h("div","chips");
  HOUR_PRESETS.forEach(p => {
    const active = state.current[fieldDe] === p.de && state.current[fieldA] === p.a;
    const chip = h("button", `chip${active?" active":""}`, p.l);
    chip.addEventListener("click", () => {
      haptic();
      state.current[fieldDe] = p.de; state.current[fieldA] = p.a;
      saveDraft(); renderForm();
    });
    row.appendChild(chip);
  });
  d.appendChild(row);
  return d;
}

// â”€â”€â”€ Input with Suggestions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkInputSuggest(label, field, placeholder, index) {
  const d = index !== undefined
    ? mkArrayInput(label, field, index, placeholder)
    : mkInput(label, field, "text", placeholder);
  const suggs = index !== undefined ? getSuggestions(field, index) : getSuggestions(field);
  if(suggs.length > 0) {
    const row = h("div","suggest-row");
    suggs.forEach(s => {
      const chip = h("button","suggest-chip",s);
      chip.addEventListener("click", () => {
        haptic();
        if(index !== undefined) {
          const arr = [...(state.current[field]||[])]; arr[index] = s; state.current[field] = arr;
        } else { state.current[field] = s; }
        saveDraft(); renderForm();
      });
      row.appendChild(chip);
    });
    d.appendChild(row);
  }
  return d;
}

// â”€â”€â”€ Swipe Handler for Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupCardSwipe(wrap, card, onSwipeOpen) {
  let startX = 0, startY = 0, swiped = false, moved = false;
  card.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX; startY = e.touches[0].clientY; moved = false;
  }, {passive:true});
  card.addEventListener("touchmove", e => {
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    if(Math.abs(dx) > 15 && Math.abs(dx) > Math.abs(dy)) moved = true;
    if(moved) {
      const tx = Math.max(Math.min(dx, swiped ? 0 : 10), -160);
      card.style.transform = `translateX(${swiped ? tx - 160 : tx}px)`;
    }
  }, {passive:true});
  card.addEventListener("touchend", e => {
    const dx = e.changedTouches[0].clientX - startX;
    if(moved && dx < -60 && !swiped) {
      card.style.transform = "translateX(-160px)"; swiped = true;
      if(onSwipeOpen) onSwipeOpen();
    } else if(moved && dx > 40 && swiped) {
      card.style.transform = "translateX(0)"; swiped = false;
    } else if(moved) {
      card.style.transform = swiped ? "translateX(-160px)" : "translateX(0)";
    }
  }, {passive:true});
  return { isSwiped: () => swiped || moved, reset: () => { card.style.transform = "translateX(0)"; swiped = false; } };
}

// â”€â”€â”€ Select Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkSelect(label, options, field, placeholder="SÃ©lectionner...") {
  const d = h("div","field");
  if(label) d.appendChild(h("label","label",label));
  const sel = h("select","select-native");
  const defOpt = h("option",null,placeholder);
  defOpt.value = "";
  if(!state.current[field]) defOpt.selected = true;
  sel.appendChild(defOpt);
  options.forEach(opt => {
    const o = h("option",null,opt);
    o.value = opt;
    if(state.current[field] === opt) o.selected = true;
    sel.appendChild(o);
  });
  sel.addEventListener("change", e => { state.current[field] = e.target.value; saveDraft(); });
  d.appendChild(sel);
  return d;
}

// â”€â”€â”€ Photo Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkPhoto(label, field, renderFn) {
  const d = h("div","photo-wrap");
  if(label) d.appendChild(h("label","label",label));
  const fileInput = h("input",null,null,{type:"file",accept:"image/*",capture:"environment"});
  fileInput.style.display = "none";

  const hasPhoto = !!state.current[field];
  if(!hasPhoto) {
    const btn = h("button","photo-btn btn",`ğŸ“¸ ${label||"Prendre une photo"}`);
    btn.addEventListener("click", () => fileInput.click());
    d.appendChild(btn);
  } else {
    const preview = h("div","photo-preview");
    const img = h("img");
    img.src = state.current[field];
    preview.appendChild(img);
    const rmBtn = h("button","photo-remove","âœ•");
    rmBtn.addEventListener("click", () => { state.current[field] = ""; saveDraft(); (renderFn||renderForm)(); });
    preview.appendChild(rmBtn);
    d.appendChild(preview);
  }

  fileInput.addEventListener("change", ev => {
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = re => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const MAX = 800;
        let w = img.width, ht = img.height;
        if(w > MAX) { ht = ht * MAX / w; w = MAX; }
        if(ht > MAX) { w = w * MAX / ht; ht = MAX; }
        canvas.width = w; canvas.height = ht;
        canvas.getContext("2d").drawImage(img, 0, 0, w, ht);
        state.current[field] = canvas.toDataURL("image/jpeg", 0.7);
        saveDraft();
        (renderFn||renderForm)();
      };
      img.src = re.target.result;
    };
    reader.readAsDataURL(file);
  });
  d.appendChild(fileInput);
  return d;
}

// â”€â”€â”€ Profile Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkProfiles(renderFn) {
  const d = h("div","field");
  d.appendChild(h("label","label","Profil rapide â€” 1 tap pour prÃ©-remplir"));
  const row = h("div","profiles-row");
  PROFILES.forEach(p => {
    const card = h("div",`profile-card${state.current.profile===p.id?" selected":""}`);
    card.appendChild(h("div","profile-icon",p.icon));
    card.appendChild(h("div","profile-name",p.name));
    card.appendChild(h("div","profile-desc",p.desc));
    card.addEventListener("click", () => {
      if(state.current.profile === p.id) {
        state.current.profile = "";
      } else {
        state.current.profile = p.id;
        Object.entries(p.defaults).forEach(([k,v]) => {
          state.current[k] = Array.isArray(v) ? [...v] : v;
        });
      }
      saveDraft();
      (renderFn||renderForm)();
    });
    row.appendChild(card);
  });
  d.appendChild(row);
  return d;
}

// â”€â”€â”€ Bloc Renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBloc0(container) {
  container.appendChild(mkSection("Identification","ğŸ“"));
  container.appendChild(mkHint("Infos essentielles sur l'Ã©tablissement. Les champs marquÃ©s * sont obligatoires."));

  // Profil rapide
  container.appendChild(mkGroup("Profil rapide", [mkProfiles()], "âš¡"));

  container.appendChild(mkGroup("L'Ã©tablissement", [
    mkInput("Nom Ã©tablissement <span class='req'>*</span>","nom","text","Ex: Chez Tantie Rose"),
    mkInput("Adresse complÃ¨te <span class='req'>*</span>","adresse","text","Rue, nÂ°, bÃ¢timent..."),
    mkSelect("Quartier / Zone <span class='req'>*</span>", C.quartiers, "quartier", "Choisir un quartier..."),
  ], "ğŸª"));

  const gpsLat = mkInput("Latitude","gpsLat","number");
  const gpsLong = mkInput("Longitude","gpsLong","number");
  const gpsGrid = h("div","grid2");
  gpsGrid.appendChild(gpsLat);
  gpsGrid.appendChild(gpsLong);
  const gpsBtn = h("button","btn btn-secondary","ğŸ“¡ Localisation GPS auto");
  gpsBtn.addEventListener("click", () => {
    if(navigator.geolocation) {
      gpsBtn.innerHTML = "ğŸ“¡ Recherche en cours...";
      navigator.geolocation.getCurrentPosition(pos => {
        state.current.gpsLat = pos.coords.latitude.toFixed(6);
        state.current.gpsLong = pos.coords.longitude.toFixed(6);
        saveDraft();
        reverseGeocode(pos.coords.latitude, pos.coords.longitude);
        showToast("Position GPS capturÃ©e","success","ğŸ“");
        renderForm();
      }, err => {
        showToast("GPS indisponible: " + err.message,"warning","âš ");
        gpsBtn.innerHTML = "ğŸ“¡ Localisation GPS auto";
      }, {enableHighAccuracy:true,timeout:10000});
    }
  });
  container.appendChild(mkCollapsible("Localisation GPS", [gpsGrid, gpsBtn], "ğŸ“¡", !!(state.current.gpsLat)));

  // Photo du lieu
  container.appendChild(mkGroup("Photo du lieu", [mkPhoto("Photographier le lieu","photoLieu")], "ğŸ“¸"));

  container.appendChild(mkGroup("Visite", [
    mkInput("Date visite <span class='req'>*</span>","dateVisite","date"),
    mkInput("Spawter collecteur <span class='req'>*</span>","spawter","text","Votre nom"),
  ], "ğŸ“…"));

  container.appendChild(mkCollapsible("Contact (optionnel)", [
    mkInput("TÃ©lÃ©phone","telephone","tel","+225 XX XX XX XX XX"),
    mkChips("PrÃ©sence digitale", C.digital, "digital"),
    mkInput("URL / Handle","urlHandle","text","@nom ou https://..."),
  ], "ğŸ“±", !!(state.current.telephone || (state.current.digital||[]).length)));
}

function renderBloc1(container) {
  container.appendChild(mkSection("Typologie & Offre","ğŸ½ï¸"));
  container.appendChild(mkHint("Classifie le lieu et son offre culinaire."));

  container.appendChild(mkGroup("Classification", [
    mkChips("Type d'Ã©tablissement", C.types, "types"),
    mkInput("Autre type (si besoin)","autreType","text","PrÃ©ciser..."),
  ], "ğŸ·ï¸"));

  container.appendChild(mkGroup("Cuisine & SpÃ©cialitÃ©s", [
    mkChips("Cuisine dominante", C.cuisines, "cuisines"),
    mkInput("Autre cuisine","autreCuisine","text","PrÃ©ciser..."),
    mkInputSuggest("SpÃ©cialitÃ© 1","specs","Ex: AttiÃ©kÃ© poisson",0),
    mkInputSuggest("SpÃ©cialitÃ© 2","specs","Ex: Alloco",1),
    mkInputSuggest("SpÃ©cialitÃ© 3","specs","Ex: KÃ©djÃ©nou",2),
    mkTextarea("Plats signature observÃ©s","platsSignature","Ce qui les distingue..."),
  ], "ğŸ‘¨â€ğŸ³"));

  container.appendChild(mkGroup("Grille tarifaire (FCFA)", [
    mkPriceChips("Budget Ã©co", "ecoMin", "ecoMax", PRICE_RANGES.eco),
    mkPriceChips("Budget moyen", "moyMin", "moyMax", PRICE_RANGES.moy),
    mkPriceChips("Budget premium", "premMin", "premMax", PRICE_RANGES.prem),
    mkPriceChips("Boissons", "boissMin", "boissMax", PRICE_RANGES.boiss),
    mkChips("Format du menu", C.menu, "menuType"),
  ], "ğŸ’°"));

  // Photos menu et plats
  container.appendChild(mkGroup("Photos (optionnel)", [
    mkPhoto("Photographier le menu / ardoise","photoMenu"),
    mkPhoto("Photographier les plats","photoPlats"),
  ], "ğŸ“¸"));
}

function renderBloc2(container) {
  container.appendChild(mkSection("ADN QuantifiÃ©","ğŸ§¬"));
  container.appendChild(mkHint("Ã‰value les 5 dimensions clÃ©s du lieu sur une Ã©chelle de 1 Ã  12."));

  container.appendChild(mkGroup("Budget", [
    mkSlider("Repas complet pour 1 personne","budget","< 2 000 F","> 15 000 F","ğŸª™","ğŸ’"),
    mkInput("Estimation prÃ©cise (FCFA)","budgetEst","number","Ex: 3500"),
  ], "ğŸ’°"));

  container.appendChild(mkGroup("Cadence", [
    mkSlider("Vitesse du service","cadence","TrÃ¨s lent","Ultra rapide","ğŸŒ","âš¡"),
    mkInput("Temps d'attente observÃ© (min)","tempsAtt","number","Ex: 15"),
  ], "â±ï¸"));

  container.appendChild(mkGroup("Ambiance", [
    mkSlider("Niveau de formalitÃ©","ambiance","DÃ©contractÃ©","TrÃ¨s formel","ğŸ˜","ğŸ©"),
    mkInput("Notes ambiance","ambianceN","text","DÃ©cris l'ambiance..."),
  ], "ğŸ­"));

  container.appendChild(mkGroup("SociabilitÃ©", [
    mkSlider("Dynamique sociale","sociabilite","Solo-friendly","Groupes","ğŸ§˜","ğŸ‘¥"),
    mkInput("Notes sociabilitÃ©","sociabiliteN","text","Type de frÃ©quentation..."),
  ], "ğŸ‘¥"));

  container.appendChild(mkGroup("NotoriÃ©tÃ©", [
    mkSlider("Niveau de connaissance","notoriete","Bouche-Ã -oreille","Institution","ğŸ¤«","ğŸ›ï¸"),
    mkInput("Notes notoriÃ©tÃ©","notorieteN","text","Comment les gens connaissent..."),
  ], "ğŸ“£"));
}

function renderBloc3(container) {
  container.appendChild(mkSection("Profil OpÃ©rationnel","â°"));
  container.appendChild(mkHint("Horaires, capacitÃ© et services pratiques du lieu."));

  const timeGrid = h("div","grid-time");
  timeGrid.appendChild(h("span","mini-label","L-V"));
  timeGrid.appendChild(mkInput(null,"hLVde","time"));
  timeGrid.appendChild(h("span","mini-label","Ã "));
  timeGrid.appendChild(mkInput(null,"hLVa","time"));
  timeGrid.appendChild(h("span","mini-label","Sam"));
  timeGrid.appendChild(mkInput(null,"hSde","time"));
  timeGrid.appendChild(h("span","mini-label","Ã "));
  timeGrid.appendChild(mkInput(null,"hSa","time"));
  timeGrid.appendChild(h("span","mini-label","Dim"));
  timeGrid.appendChild(mkInput(null,"hDde","time"));
  timeGrid.appendChild(h("span","mini-label","Ã "));
  timeGrid.appendChild(mkInput(null,"hDa","time"));
  const horaireChildren = [
    mkHourPresets("hLVde","hLVa"),
    timeGrid,
    mkToggle("Dimanche fermÃ©","dimFerme"),
    mkChips("Service continu ?",["Oui","Non"],"continu",false),
  ];
  if(state.current.continu==="Non") horaireChildren.push(mkInput("Horaires de coupure","coupures","text","Ex: 14h-18h"));
  horaireChildren.push(mkInput("Jours de fermeture hebdo","joursFerm","text","Ex: Lundi"));
  container.appendChild(mkGroup("Horaires", horaireChildren, "ğŸ•"));

  const cap = h("div","grid2");
  cap.appendChild(mkInput("Places intÃ©rieur","capInt","number","Ex: 30"));
  cap.appendChild(mkInput("Places extÃ©rieur","capExt","number","Ex: 20"));
  container.appendChild(mkGroup("CapacitÃ© d'accueil", [cap], "ğŸ’º"));

  container.appendChild(mkGroup("Moyens de paiement", [
    mkChips(null, C.paiements, "paiements"),
  ], "ğŸ’³"));

  container.appendChild(mkCollapsible("AccessibilitÃ©", [
    mkChips("Parking", C.parking, "parking", false),
    mkInput("PrÃ©cisions parking","parkingN","text","DÃ©tails stationnement..."),
  ], "ğŸ…¿ï¸", !!state.current.parking));

  container.appendChild(mkGroup("Services additionnels", [
    mkChips(null, C.services, "services"),
  ], "ğŸ›ï¸"));
}

function renderBloc4(container) {
  container.appendChild(mkSection("Ã‰valuation Spawter","â­"));
  container.appendChild(mkHint("Ton avis personnel aprÃ¨s la visite ou le test."));

  container.appendChild(mkGroup("As-tu testÃ© ?", [mkToggle("Test effectuÃ©","tested")], "ğŸ´"));

  if(state.current.tested) {
    container.appendChild(mkGroup("DÃ©tails du test", [
      mkInput("Plat(s) testÃ©(s)","platsTestes","text","Qu'as-tu commandÃ© ?"),
      mkInput("Budget dÃ©pensÃ© (FCFA)","budgetTest","number","Ex: 5000"),
      h("label","label","Ã‰valuation globale"),
      mkStars("eval"),
    ], "ğŸ§ª"));

    container.appendChild(mkGroup("Points forts", [
      mkArrayInput(null,"forts",0,"Point fort #1"),
      mkArrayInput(null,"forts",1,"Point fort #2"),
      mkArrayInput(null,"forts",2,"Point fort #3"),
    ], "ğŸ‘"));

    container.appendChild(mkGroup("Points faibles", [
      mkArrayInput(null,"faibles",0,"Point faible #1"),
      mkArrayInput(null,"faibles",1,"Point faible #2"),
      mkArrayInput(null,"faibles",2,"Point faible #3"),
    ], "ğŸ‘"));
  }

  container.appendChild(mkGroup("Impression gÃ©nÃ©rale", [
    mkChips("Tags Ã©motionnels", C.tags, "tags"),
    mkChips("Recommandable ?", C.reco, "reco", false),
    mkInput("Phrase d'accroche (pour l'app)","accroche","text","La phrase qui rÃ©sume ce lieu..."),
  ], "ğŸ’¬"));
}

function renderBloc5(container) {
  container.appendChild(mkSection("Intelligence Terrain","ğŸ”"));
  container.appendChild(mkHint("Ce que tu observes sur place : la clientÃ¨le, l'ambiance, la qualitÃ©."));

  container.appendChild(mkGroup("Ambiance du moment", [
    mkChips("ClientÃ¨le observÃ©e", C.clientele, "clientele"),
    mkChips("Moment optimal", C.moments, "moments"),
    mkChips("Affluence", C.affluence, "affluence", false),
    mkChips("Niveau sonore", C.sonore, "sonore", false),
  ], "ğŸ‘€"));

  container.appendChild(mkGroup("QualitÃ© du lieu", [
    mkChips("PropretÃ©", C.proprete, "proprete", false),
    mkSelect("Nombre de serveurs", ["1","2","3","4","5","6","7","8","9","10+"], "serveurs", "Combien de serveurs ?"),
    mkChips("QualitÃ© de l'accueil", C.accueil, "accueil", false),
  ], "âœ¨"));

  container.appendChild(mkGroup("Verdict Spawt", [
    mkChips("Potentiel", C.potentiel, "potentiel", false),
    mkTextarea("Notes libres terrain","notes","Tout ce qui te semble important...",3),
    mkVoiceMemo("Ou dicte tes notes", "voiceNotes"),
  ], "ğŸ¯"));
}

function renderBloc6(container) {
  container.appendChild(mkSection("Approche B2B","ğŸ¤"));
  container.appendChild(mkHint("Si tu as eu un contact avec le gÃ©rant ou le propriÃ©taire."));

  container.appendChild(mkGroup("Statut du contact", [
    mkChips("Contact Ã©tabli ?",["Oui","Non","Ã€ recontacter"],"contactEtabli",false),
  ], "ğŸ“"));

  if(state.current.contactEtabli==="Oui") {
    const contactChildren = [
      mkInput("Nom du contact","contactNom","text","PrÃ©nom Nom"),
      mkChips("Fonction", C.fonction, "fonction", false),
      mkChips("RÃ©ceptivitÃ©", C.receptivite, "receptivite", false),
      mkToggle("RDV planifiÃ©","rdv"),
    ];
    if(state.current.rdv) contactChildren.push(mkInput("Date du RDV","rdvDate","date"));
    contactChildren.push(mkChips("MatÃ©riel laissÃ©", C.materiel, "materiel"));
    container.appendChild(mkGroup("DÃ©tails du contact", contactChildren, "ğŸ¤"));
  }

  container.appendChild(mkGroup("Notes", [
    mkTextarea("Notes approche commerciale","notesB2B","RÃ©sumÃ© de l'Ã©change, prochaines Ã©tapes...",3),
    mkVoiceMemo("Ou dicte tes notes", "voiceB2B"),
  ], "ğŸ“"));

  // Summary before save on last bloc
  renderSummary(container);
}

function renderSummary(container) {
  const e = state.current;
  container.appendChild(mkSection("RÃ©capitulatif","ğŸ“‹"));
  container.appendChild(mkHint("AperÃ§u rapide avant de sauvegarder."));

  const card = h("div","summary-card");
  const rows = [
    ["Nom", e.nom],
    ["Quartier", e.quartier],
    ["Type", (e.types||[]).join(", ")],
    ["Cuisine", (e.cuisines||[]).join(", ")],
    ["Potentiel", (() => { const p = C.potentiel.find(x=>x.id===e.potentiel); return p ? `${p.e} ${p.l}` : ""; })()],
    ["Recommandable", e.reco],
    ["Budget /12", e.budget ? String(e.budget) : ""],
    ["Test effectuÃ©", e.tested ? "Oui" : "Non"],
    ["Contact B2B", e.contactEtabli],
  ];
  rows.forEach(([k, v]) => {
    const row = h("div","summary-row");
    row.appendChild(h("span","summary-key",k));
    row.appendChild(h("span", v ? "summary-val" : "summary-val empty", v || "â€”"));
    card.appendChild(row);
  });
  container.appendChild(card);
}

const BLOCS = [
  {t:"Identif.",i:"ğŸ“",r:renderBloc0},
  {t:"Offre",i:"ğŸ½ï¸",r:renderBloc1},
  {t:"ADN",i:"ğŸ§¬",r:renderBloc2},
  {t:"OpÃ©ra.",i:"â°",r:renderBloc3},
  {t:"Ã‰val.",i:"â­",r:renderBloc4},
  {t:"Terrain",i:"ğŸ”",r:renderBloc5},
  {t:"B2B",i:"ğŸ¤",r:renderBloc6},
];

// â”€â”€â”€ Quick Save Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doQuickSave(e) {
  e.quickCapture = true;
  e.spawter = lastSpawter() || "Spawter";
  if(e.spawter) { try { localStorage.setItem(SPAWTER_KEY, e.spawter); } catch(ex) {} }
  const idx = state.entries.findIndex(x => x.id === e.id);
  if(idx >= 0) state.entries[idx] = e;
  else state.entries.unshift(e);
  save(); clearDraft();
  state.view = "list"; renderList();
  haptic();
  showToast(`"${e.nom||"Nouveau lieu"}" capturÃ© !`,"success","âš¡");
}

// â”€â”€â”€ Render: Quick Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuickCapture() {
  const app = $("#app");
  app.innerHTML = "";
  const e = state.current;

  // Header
  const hdr = h("div","header");
  const backBtn = h("button","btn btn-back","âœ•");
  backBtn.addEventListener("click", () => { state.view = "list"; renderList(); });
  hdr.appendChild(backBtn);
  hdr.appendChild(h("div",null,'<span style="font-weight:700;font-size:15px;color:var(--accent)">CAPTURE RAPIDE</span>'));
  hdr.appendChild(h("div",null,null)).style.width = "38px"; // spacer
  app.appendChild(hdr);

  // Scroll content
  const scroll = h("div","scroll");
  scroll.style.padding = "16px 20px";

  // Auto GPS
  const gpsHas = e.gpsLat && e.gpsLong;
  const gpsRow = h("div",`quick-gps${gpsHas?" captured":""}`);
  gpsRow.appendChild(h("div","gps-dot"));
  gpsRow.appendChild(h("span",null, gpsHas
    ? `ğŸ“ Position capturÃ©e (${Number(e.gpsLat).toFixed(4)}, ${Number(e.gpsLong).toFixed(4)})`
    : "ğŸ“¡ Capture GPS en cours..."));
  scroll.appendChild(gpsRow);

  // Auto-trigger GPS + reverse geocode
  if(!gpsHas && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      e.gpsLat = pos.coords.latitude.toFixed(6);
      e.gpsLong = pos.coords.longitude.toFixed(6);
      saveDraft();
      reverseGeocode(pos.coords.latitude, pos.coords.longitude);
      const el = $(".quick-gps", app);
      if(el) {
        el.className = "quick-gps captured";
        el.querySelector("span").innerHTML = `ğŸ“ Position capturÃ©e (${Number(e.gpsLat).toFixed(4)}, ${Number(e.gpsLong).toFixed(4)})`;
        el.querySelector(".gps-dot").style.background = "var(--green)";
      }
    }, () => {}, {enableHighAccuracy:true,timeout:10000});
  }

  // Nom â€” auto-focus
  scroll.appendChild(h("div","quick-section","Nom du lieu"));
  const nomInput = h("input","quick-input",null,{type:"text",placeholder:"Ex: Chez Tantie Rose",value:e.nom});
  nomInput.addEventListener("input", ev => { e.nom = ev.target.value; saveDraft(); });
  scroll.appendChild(nomInput);
  requestAnimationFrame(() => { if(!e.nom) nomInput.focus(); });

  // Profil rapide
  scroll.appendChild(h("div","quick-section","Profil rapide"));
  scroll.appendChild(mkProfiles(renderQuickCapture));

  // Type
  scroll.appendChild(h("div","quick-section","Type de lieu"));
  const typeChips = h("div","chips");
  C.types.forEach(t => {
    const active = (e.types||[]).includes(t);
    const chip = h("button",`chip${active?" active":""}`,t);
    chip.addEventListener("click", () => {
      const arr = [...(e.types||[])];
      const idx = arr.indexOf(t);
      if(idx>=0) arr.splice(idx,1); else arr.push(t);
      e.types = arr;
      saveDraft();
      renderQuickCapture();
    });
    typeChips.appendChild(chip);
  });
  scroll.appendChild(typeChips);

  // Potentiel
  scroll.appendChild(h("div","quick-section","Ton verdict"));
  const potChips = h("div","chips");
  C.potentiel.forEach(p => {
    const active = e.potentiel === p.id;
    const chip = h("button",`chip${active?" active":""}`,`${p.e} ${p.l}`);
    chip.style.fontSize = "14px";
    chip.style.padding = "10px 16px";
    chip.addEventListener("click", () => {
      e.potentiel = e.potentiel === p.id ? "" : p.id;
      saveDraft();
      renderQuickCapture();
    });
    potChips.appendChild(chip);
  });
  scroll.appendChild(potChips);

  // Photo
  scroll.appendChild(h("div","quick-section","Photo du lieu (optionnel)"));
  scroll.appendChild(mkPhoto("Photo du lieu","photoLieu",renderQuickCapture));

  // Accroche
  scroll.appendChild(h("div","quick-section","En un mot (optionnel)"));
  const accInput = h("input","input",null,{type:"text",placeholder:"Ta phrase d'accroche...",value:e.accroche||""});
  accInput.style.fontSize = "15px";
  accInput.addEventListener("input", ev => { e.accroche = ev.target.value; saveDraft(); });
  scroll.appendChild(accInput);

  // Actions
  const actions = h("div","quick-actions");
  const saveBtn = h("button","btn btn-quick-save","âœ“ Enregistrer");
  saveBtn.addEventListener("click", () => {
    const dup = checkDuplicate(e);
    if(dup) {
      showConfirm("Doublon possible",
        `"${dup.nom||"Sans nom"}" existe dÃ©jÃ  avec un nom ou GPS similaire. Enregistrer quand mÃªme ?`,
        "Enregistrer", () => { doQuickSave(e); });
      return;
    }
    doQuickSave(e);
  });
  actions.appendChild(saveBtn);

  const fullBtn = h("button","btn btn-quick-full","Mode complet â†’");
  fullBtn.addEventListener("click", () => {
    e.quickCapture = false;
    state.bloc = 0;
    state.view = "form";
    renderForm();
  });
  actions.appendChild(fullBtn);
  scroll.appendChild(actions);

  app.appendChild(scroll);
}

// â”€â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const esc = v => { const s=String(v??""); return s.includes(",")||s.includes('"')||s.includes("\n") ? `"${s.replace(/"/g,'""')}"` : s; };
  const rows = state.entries.map(e => ({
    "Nom":e.nom,"Adresse":e.adresse,"Quartier":e.quartier,"GPS Lat":e.gpsLat,"GPS Long":e.gpsLong,
    "Date visite":e.dateVisite,"Spawter":e.spawter,"TÃ©lÃ©phone":e.telephone,
    "PrÃ©sence digitale":(e.digital||[]).join("|"),"URL":e.urlHandle,
    "Type":(e.types||[]).join("|"),"SpÃ©cialitÃ© 1":(e.specs||[])[0]||"","SpÃ©cialitÃ© 2":(e.specs||[])[1]||"","SpÃ©cialitÃ© 3":(e.specs||[])[2]||"",
    "Cuisine":(e.cuisines||[]).join("|"),"Plats signature":e.platsSignature,
    "Ã‰co min":e.ecoMin,"Ã‰co max":e.ecoMax,"Moyen min":e.moyMin,"Moyen max":e.moyMax,
    "Premium min":e.premMin,"Premium max":e.premMax,"Boissons min":e.boissMin,"Boissons max":e.boissMax,
    "Menu":(e.menuType||[]).join("|"),
    "Budget /12":e.budget,"Budget FCFA":e.budgetEst,"Cadence /12":e.cadence,"Temps attente":e.tempsAtt,
    "Ambiance /12":e.ambiance,"Ambiance notes":e.ambianceN,"SociabilitÃ© /12":e.sociabilite,"SociabilitÃ© notes":e.sociabiliteN,
    "NotoriÃ©tÃ© /12":e.notoriete,"NotoriÃ©tÃ© notes":e.notorieteN,
    "Horaires L-V":e.hLVde&&e.hLVa?`${e.hLVde}-${e.hLVa}`:"","Horaires Sam":e.hSde&&e.hSa?`${e.hSde}-${e.hSa}`:"",
    "Horaires Dim":e.dimFerme?"FermÃ©":(e.hDde&&e.hDa?`${e.hDde}-${e.hDa}`:""),
    "Service continu":e.continu,"Places int.":e.capInt,"Places ext.":e.capExt,
    "Paiements":(e.paiements||[]).join("|"),"Parking":e.parking,"Services":(e.services||[]).join("|"),
    "Test":e.tested?"Oui":"Non","Plats testÃ©s":e.platsTestes,"Budget test":e.budgetTest,
    "Ã‰valuation /5":e.tested?e.eval:"",
    "Fort 1":(e.forts||[])[0]||"","Fort 2":(e.forts||[])[1]||"","Fort 3":(e.forts||[])[2]||"",
    "Faible 1":(e.faibles||[])[0]||"","Faible 2":(e.faibles||[])[1]||"","Faible 3":(e.faibles||[])[2]||"",
    "Tags":(e.tags||[]).join("|"),"Recommandable":e.reco,"Accroche":e.accroche,
    "ClientÃ¨le":(e.clientele||[]).join("|"),"Moment":(e.moments||[]).join("|"),
    "Affluence":e.affluence,"Sonore":e.sonore,"PropretÃ©":e.proprete,
    "Serveurs":e.serveurs,"Accueil":e.accueil,"Potentiel":e.potentiel,"Notes":e.notes,
    "Contact B2B":e.contactEtabli,"Contact nom":e.contactNom,"Fonction":e.fonction,
    "RÃ©ceptivitÃ©":e.receptivite,"RDV":e.rdv?`Oui - ${e.rdvDate}`:"Non","Notes B2B":e.notesB2B,
    "Profil":e.profile||"","Capture rapide":e.quickCapture?"Oui":"Non",
    "Photo lieu":e.photoLieu?"Oui":"Non","Photo menu":e.photoMenu?"Oui":"Non","Photo plats":e.photoPlats?"Oui":"Non",
    "MÃ©mo vocal terrain":e.voiceNotes?"Oui":"Non","MÃ©mo vocal B2B":e.voiceB2B?"Oui":"Non",
  }));

  if(!rows.length) return;
  const hdr = Object.keys(rows[0]);
  const csv = "\uFEFF" + [hdr.map(esc).join(","), ...rows.map(r=>hdr.map(k=>esc(r[k])).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `SPAWT_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast(`${state.entries.length} entrÃ©e(s) exportÃ©e(s)`,"success","ğŸ“Š");
}

// â”€â”€â”€ Render: List View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const app = $("#app");
  app.innerHTML = "";

  // Offline indicator
  if(!state.isOnline) {
    const offBar = h("div","offline-bar");
    offBar.appendChild(h("div","online-dot off"));
    offBar.appendChild(h("span",null,"Mode hors-ligne â€” DonnÃ©es sauvegardÃ©es localement"));
    app.appendChild(offBar);
  }

  // Header
  const hdr = h("div","header");
  const left = h("div");
  left.appendChild(h("div","header-title","SPAWT"));
  left.appendChild(h("div","header-sub",`Collecte Terrain Â· ${state.entries.length} lieu${state.entries.length!==1?"x":""}`));
  hdr.appendChild(left);

  const right = h("div",null,null);
  right.style.cssText = "display:flex;gap:8px;align-items:center";
  if(state.entries.length > 0) {
    const expBtn = h("button","btn btn-icon","ğŸ“Š");
    expBtn.addEventListener("click", exportCSV);
    right.appendChild(expBtn);
  }
  const newBtn = h("button","btn btn-primary","âš¡ Capturer");
  newBtn.addEventListener("click", () => {
    state.current = emptyEntry();
    state.view = "quick";
    renderQuickCapture();
  });
  right.appendChild(newBtn);
  hdr.appendChild(right);
  app.appendChild(hdr);

  // Stats bar
  if(state.entries.length > 0) {
    const stats = h("div","stats-row");
    const nEnrich = state.entries.filter(e => e.quickCapture).length;
    const potCounts = {};
    C.potentiel.forEach(p => { potCounts[p.id] = 0; });
    state.entries.forEach(e => { if(e.potentiel && potCounts[e.potentiel] !== undefined) potCounts[e.potentiel]++; });
    const parts = [`${state.entries.length} lieux`];
    C.potentiel.forEach(p => { if(potCounts[p.id] > 0) parts.push(`${potCounts[p.id]} ${p.e}`); });
    if(nEnrich > 0) parts.push(`${nEnrich} Ã  enrichir`);
    stats.appendChild(h("div","stat-badge",parts.join(" Â· ")));
    app.appendChild(stats);
  }

  // Draft recovery banner
  const draft = loadDraft();
  if(draft && draft.entry) {
    const age = Date.now() - (draft.ts || 0);
    if(age < 86400000) {
      const banner = h("div","draft-banner");
      const name = draft.entry.nom || "Sans nom";
      banner.appendChild(h("span","draft-banner-text",`ğŸ“ Brouillon : ${name}`));
      const actions = h("div","draft-banner-actions");
      const restoreBtn = h("button","btn btn-draft-restore","Reprendre");
      restoreBtn.addEventListener("click", () => {
        state.current = draft.entry;
        state.bloc = draft.bloc || 0;
        state.view = "form";
        renderForm();
        showToast("Brouillon restaurÃ©","success","ğŸ“");
      });
      const dismissBtn = h("button","btn btn-draft-dismiss","Ignorer");
      dismissBtn.addEventListener("click", () => { clearDraft(); renderList(); });
      actions.appendChild(restoreBtn);
      actions.appendChild(dismissBtn);
      banner.appendChild(actions);
      app.appendChild(banner);
    }
  }

  // Search + Filter + Sort
  if(state.entries.length > 0) {
    const sb = h("div","search-bar");
    const si = h("input","input",null,{type:"text",placeholder:"ğŸ”  Rechercher un lieu..."});
    si.value = state.search;
    si.addEventListener("input", e => { state.search = e.target.value; renderList(); });
    sb.appendChild(si);
    app.appendChild(sb);

    const fr = h("div","filter-row");
    const allBtn = h("button",`filter-chip${state.filterPot===""?" active":""}`,"Tous");
    allBtn.addEventListener("click", () => { state.filterPot = ""; renderList(); });
    fr.appendChild(allBtn);
    C.potentiel.forEach(p => {
      const fb = h("button",`filter-chip${state.filterPot===p.id?" active":""}`,`${p.e} ${p.l}`);
      fb.addEventListener("click", () => { state.filterPot = state.filterPot===p.id?"":p.id; renderList(); });
      fr.appendChild(fb);
    });
    app.appendChild(fr);

    // Sort row
    const sortRow = h("div","sort-row");
    sortRow.appendChild(h("span","sort-label","Tri :"));
    const sorts = [{id:"date",l:"Date"},{id:"name",l:"Nom"},{id:"potentiel",l:"Potentiel"},{id:"quartier",l:"Quartier"}];
    sorts.forEach(s => {
      const chip = h("button",`sort-chip${state.sortBy===s.id?" active":""}`,s.l);
      chip.addEventListener("click", () => { state.sortBy = s.id; renderList(); });
      sortRow.appendChild(chip);
    });
    app.appendChild(sortRow);
  }

  // Entry list â€” filter + sort
  const list = h("div","list-scroll");
  let filtered = state.entries.filter(e => {
    const ms = !state.search || (e.nom||"").toLowerCase().includes(state.search.toLowerCase()) || (e.quartier||"").toLowerCase().includes(state.search.toLowerCase());
    const mp = !state.filterPot || e.potentiel === state.filterPot;
    return ms && mp;
  });

  // Sort
  const potOrder = ["pepite","coup_coeur","solide","moyen","skip",""];
  filtered = [...filtered].sort((a, b) => {
    switch(state.sortBy) {
      case "name": return (a.nom||"").localeCompare(b.nom||"");
      case "potentiel": return (potOrder.indexOf(a.potentiel||"")) - (potOrder.indexOf(b.potentiel||""));
      case "quartier": return (a.quartier||"").localeCompare(b.quartier||"");
      default: return (b.dateVisite||"").localeCompare(a.dateVisite||"");
    }
  });

  if(filtered.length === 0 && state.entries.length === 0) {
    const em = h("div","empty");
    em.appendChild(h("div","empty-ico","ğŸ½ï¸"));
    em.appendChild(h("div","empty-txt",`Aucun lieu collectÃ© pour le moment.<br><br>Appuie sur <span style="color:var(--accent);font-weight:700">âš¡ Capturer</span> pour commencer.`));
    list.appendChild(em);
  } else if(filtered.length === 0) {
    list.appendChild(h("div","empty",`<div style="padding:40px;color:var(--muted)">Aucun rÃ©sultat pour cette recherche</div>`));
  }

  filtered.forEach(entry => {
    // Swipe wrapper
    const wrap = h("div","card-swipe-wrap");
    const card = h("button","entry-card btn");
    const pot = C.potentiel.find(p=>p.id===entry.potentiel);
    const top = h("div",null,null);
    top.style.cssText = "display:flex;justify-content:space-between;align-items:flex-start";
    const info = h("div",null,null);
    info.style.flex = "1";
    const nameRow = h("div",null,null);
    nameRow.style.cssText = "display:flex;align-items:center;gap:6px;flex-wrap:wrap";
    if(pot) nameRow.appendChild(h("span",null,pot.e));
    nameRow.appendChild(h("span","entry-name",entry.nom||"Sans nom"));
    if(entry.quickCapture) nameRow.appendChild(h("span","badge-enrich","Ã€ enrichir"));
    info.appendChild(nameRow);
    const meta = (entry.quartier||"") + (entry.quartier&&(entry.types||[]).length>0?" Â· ":"") + (entry.types||[]).join(", ");
    if(meta) info.appendChild(h("div","entry-meta",meta));
    top.appendChild(info);

    const rightCol = h("div",null,null);
    rightCol.style.cssText = "display:flex;flex-direction:column;align-items:flex-end;gap:4px";
    rightCol.appendChild(h("span","entry-date",entry.dateVisite));
    if(entry.tested && entry.eval) rightCol.appendChild(h("span",null,"â­".repeat(entry.eval)));
    top.appendChild(rightCol);
    card.appendChild(top);

    if(entry.accroche) card.appendChild(h("div","entry-accroche",`"${entry.accroche}"`));

    // Swipe actions behind the card
    const actionsDiv = h("div","card-swipe-actions");
    const cloneBtn = h("button","card-swipe-action card-action-clone","ğŸ“‹");
    cloneBtn.addEventListener("click", ev => { ev.stopPropagation(); duplicateEntry(entry); });
    const shareBtn = h("button","card-swipe-action card-action-share","ğŸ“¤");
    shareBtn.addEventListener("click", ev => { ev.stopPropagation(); shareEntry(entry); });
    const delBtn = h("button","card-swipe-action card-action-delete","ğŸ—‘ï¸");
    delBtn.addEventListener("click", ev => {
      ev.stopPropagation();
      showConfirm("Supprimer ?", `"${entry.nom||"Sans nom"}" sera supprimÃ©.`, "Supprimer", () => {
        state.entries = state.entries.filter(x => x.id !== entry.id);
        save(); renderList();
        showToast("Lieu supprimÃ©","info","ğŸ—‘ï¸");
      }, true);
    });
    actionsDiv.appendChild(cloneBtn);
    actionsDiv.appendChild(shareBtn);
    actionsDiv.appendChild(delBtn);
    wrap.appendChild(actionsDiv);

    // Setup swipe + click
    const swipeState = setupCardSwipe(wrap, card);
    card.addEventListener("click", () => {
      if(swipeState.isSwiped()) return;
      state.current = JSON.parse(JSON.stringify(entry));
      state.bloc = 0;
      state.view = "form";
      renderForm();
    });

    wrap.appendChild(card);
    list.appendChild(wrap);
  });

  app.appendChild(list);
}

// â”€â”€â”€ Render: Form View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForm() {
  const app = $("#app");
  app.innerHTML = "";
  const e = state.current;

  // Header
  const hdr = h("div","header");
  const backBtn = h("button","btn btn-back","âœ•");
  backBtn.addEventListener("click", () => {
    showConfirm("Quitter le formulaire ?",
      "Ton brouillon est sauvegardÃ© automatiquement, tu pourras le reprendre plus tard.",
      "Quitter", () => { state.view = "list"; renderList(); });
  });
  hdr.appendChild(backBtn);

  const center = h("div",null,null);
  center.style.cssText = "flex:1;text-align:center;overflow:hidden";
  center.appendChild(h("div",null,`<span style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block">${e.nom||"Nouveau lieu"}</span>`));
  const pct = Math.round(calcTotalProgress() * 100);
  center.appendChild(h("div",null,`<span style="font-size:11px;color:var(--dim)">${BLOCS[state.bloc].i} ${BLOCS[state.bloc].t} Â· ${pct}% complÃ©tÃ©</span>`));
  hdr.appendChild(center);

  const saveBtn = h("button","btn btn-save","ğŸ’¾");
  saveBtn.addEventListener("click", doSave);
  hdr.appendChild(saveBtn);
  app.appendChild(hdr);

  // Progress bar
  const progBar = h("div","progress-bar");
  const progFill = h("div","progress-fill");
  progFill.style.width = pct + "%";
  progBar.appendChild(progFill);
  app.appendChild(progBar);

  // Bloc nav
  const nav = h("div","bloc-nav");
  BLOCS.forEach((b, i) => {
    const tab = h("button",`bloc-tab${i===state.bloc?" active":""}`,`<span class="ico">${b.i}</span>${b.t}`);
    const prog = calcBlocProgress(i);
    const dotClass = prog >= 1 ? "complete" : prog > 0 ? "partial" : "empty";
    const dot = h("span",`dot ${dotClass}`);
    tab.appendChild(dot);
    tab.addEventListener("click", () => {
      state.prevBloc = state.bloc;
      state.bloc = i;
      renderForm();
    });
    nav.appendChild(tab);
  });
  app.appendChild(nav);

  // Scroll to active tab
  requestAnimationFrame(() => {
    const activeTab = $(".bloc-tab.active", nav);
    if(activeTab) activeTab.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"});
  });

  // Form content
  const direction = state.bloc >= (state.prevBloc||0) ? "slide-in" : "slide-in-reverse";
  const scroll = h("div",`scroll ${direction}`);
  scroll.id = "form-scroll";
  BLOCS[state.bloc].r(scroll);

  // Spacer for bottom bar
  scroll.appendChild(h("div",null,null)).style.height = "24px";

  // Delete button for existing entries
  const isExisting = state.entries.some(x => x.id === e.id);
  if(isExisting) {
    const delWrap = h("div",null,null);
    delWrap.style.cssText = "text-align:center;padding:16px 0 8px";
    const delBtn = h("button","btn btn-danger","Supprimer ce lieu");
    delBtn.addEventListener("click", () => {
      showConfirm("Supprimer ce lieu ?",
        `"${e.nom||"Sans nom"}" sera dÃ©finitivement supprimÃ©.`,
        "Supprimer", () => {
          state.entries = state.entries.filter(x => x.id !== e.id);
          save();
          clearDraft();
          state.view = "list";
          renderList();
          showToast("Lieu supprimÃ©","info","ğŸ—‘ï¸");
        }, true);
    });
    delWrap.appendChild(delBtn);
    scroll.appendChild(delWrap);
  }

  app.appendChild(scroll);

  // Setup swipe
  setupSwipe(scroll);

  // Bottom nav
  const bottom = h("div","bottom-bar");
  const prevBtn = h("button","btn btn-nav",`â† ${state.bloc > 0 ? BLOCS[state.bloc-1].t : ""}`);
  if(state.bloc === 0) { prevBtn.style.opacity = ".3"; prevBtn.textContent = "â†"; }
  prevBtn.addEventListener("click", () => {
    if(state.bloc > 0) { state.prevBloc = state.bloc; state.bloc--; renderForm(); }
  });
  bottom.appendChild(prevBtn);

  if(state.bloc < BLOCS.length - 1) {
    const nextBtn = h("button","btn btn-nav-primary",`${BLOCS[state.bloc+1].t} â†’`);
    nextBtn.addEventListener("click", () => { state.prevBloc = state.bloc; state.bloc++; renderForm(); });
    bottom.appendChild(nextBtn);
  } else {
    const saveBtn2 = h("button","btn btn-nav-primary","âœ“ Sauvegarder");
    saveBtn2.addEventListener("click", doSave);
    bottom.appendChild(saveBtn2);
  }
  app.appendChild(bottom);
}

// â”€â”€â”€ Swipe Between Blocs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupSwipe(el) {
  let startX = 0, startY = 0, startTime = 0;
  el.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startTime = Date.now();
  }, {passive:true});
  el.addEventListener("touchend", e => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    const dt = Date.now() - startTime;
    if(Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy) * 1.8 && dt < 400) {
      if(dx > 0 && state.bloc > 0) {
        state.prevBloc = state.bloc; state.bloc--; renderForm();
      } else if(dx < 0 && state.bloc < BLOCS.length - 1) {
        state.prevBloc = state.bloc; state.bloc++; renderForm();
      }
    }
  }, {passive:true});
}

// â”€â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSave() {
  const e = state.current;
  e.quickCapture = false; // saving from full mode = enriched
  // Remember spawter name
  if(e.spawter) {
    try { localStorage.setItem(SPAWTER_KEY, e.spawter); } catch(ex) {}
  }
  const idx = state.entries.findIndex(x => x.id === e.id);
  if(idx >= 0) {
    state.entries[idx] = e;
  } else {
    state.entries.unshift(e);
  }
  save();
  clearDraft();
  state.view = "list";
  renderList();
  showToast(`"${e.nom||"Nouveau lieu"}" sauvegardÃ© !`,"success","âœ“");
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();
renderList();

// Online/Offline detection
window.addEventListener("online", () => { state.isOnline = true; if(state.view === "list") renderList(); });
window.addEventListener("offline", () => { state.isOnline = false; if(state.view === "list") renderList(); showToast("Hors-ligne â€” Tes donnÃ©es sont safe","info","ğŸ“¡"); });
</script>
</body>
</html>
